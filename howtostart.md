# Микро-гайд по запуску Telegram бота

## Предварительные требования
- Python 3.8+
- Установленные зависимости из `requirements.txt`
- Токен бота от [@BotFather](https://t.me/botfather)
- Аккаунт ngrok для туннелирования

## Шаги запуска

### 1. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 2. Настройка переменных окружения
Создайте файл `.env` в корне проекта:
```
TELEGRAM_BOT_TOKEN=ваш_токен_от_BotFather
```

### 3. Запуск ngrok для туннелирования
```bash
ngrok http 8018
```
Скопируйте HTTPS URL из вывода ngrok (например: `https://abc123.ngrok.io`)

### 4. Установка webhook в Telegram
Используйте curl или браузер для установки webhook:
```bash
curl "https://api.telegram.org/bot<ВАШ_ТОКЕН>/setWebhook?url=<NGROK_URL>/webhook"
```
Замените `<ВАШ_ТОКЕН>` на токен бота и `<NGROK_URL>` на URL из ngrok.

### 5. Запуск бота
```bash
python telegram_bot.py
```

## Проверка работы
Отправьте сообщение боту в Telegram. В логах терминала вы увидите обработку webhook.

## Остановка
- Ctrl+C в терминале с ботом
- Ctrl+C в терминале с ngrok
- Удалите webhook: `curl "https://api.telegram.org/bot<ТОКЕН>/deleteWebhook"`

## Обновление токена и перезапуск бота
1. Сгенерируйте новый JWT: `./refresh_jwt.sh` (либо воспользуйтесь автоматизированным скриптом ниже).
2. Перезапустите Telegram-бота, чтобы он перечитал `.env`:
   ```bash
   python telegram_bot.py
   ```
   либо, чтобы объединить обновление токена и перезапуск в одном шаге:
   ```bash
   bash scripts/refresh_and_restart_bot.sh
   ```
   Скрипт перезапишет токен через `refresh_jwt.sh`, остановит текущий процесс бота (если запущен) и стартует его в том же терминале.

## Автоматическое обновление токена (cron)
Чтобы токен обновлялся автоматически:

1. Откройте планировщик пользователя: `crontab -e`.
2. В самые верхние строки файла добавьте переменную окружения:
   ```
   PATH=/usr/local/bin:/usr/bin:/bin
   ```
   (если уже есть PATH, обновите его, добавив нужные директории).
3. Ниже добавьте задание с полным путём к скрипту и логом:
   ```
   */30 * * * * /home/end0/TestMCP/MCPclient/scripts/refresh_jwt.sh >> /home/end0/TestMCP/MCPclient/refresh_jwt_cron.log 2>&1
   ```
4. Сохраните файл и выйдите (для nano — `Ctrl+O`, `Enter`, затем `Ctrl+X`).

- Расписание `*/30` запускает задачу каждые 30 минут; при необходимости отредактируйте интервал.
- Лог (`refresh_jwt_cron.log`) поможет проверять вывод и ошибки cron.
- Убедитесь, что у скрипта есть права на запуск: `chmod +x scripts/refresh_jwt.sh`.

## Шаблоны запросов для Telegram-бота
Формулируйте запросы так, чтобы LLM явно применяла инструменты `search` и `fetch`:

- **Список заметок за период**
  ```
  Используй инструмент поиска с параметром since=2d и выведи названия заметок, добавленных или изменённых за последние 2 дня.
  ```

- **Поиск по ключевому слову**
  ```
  Найди заметки, где упоминается «Docker», вызвав инструмент search с запросом "Docker", и перечисли их названия и дату изменения.
  ```

- **Детали конкретной заметки**
  ```
  Выполни fetch для заметки "Название ваше заметки" и верни краткое резюме содержимого.
  ```

- **Комбинированный сценарий**
  ```
  Сначала используй search с since=7d и запросом "LLM", затем для каждой найденной заметки вызови fetch и отправь дату изменения и краткое описание.
  ```

Такие шаблоны помогают боту сразу задействовать нужные инструменты и выдавать полный ответ.

## Примечания
- ngrok URL меняется при каждом запуске
- Не забудьте обновлять webhook при новом запуске ngrok
- Бот использует порт 8018 по умолчанию